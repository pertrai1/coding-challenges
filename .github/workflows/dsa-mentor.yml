name: Coding Challenge Mentor

on:
  pull_request:
    types: [opened, synchronize, labeled]
    paths:
      - 'leetcode/**'
      - 'greatfrontend/**'
      - '*-*/**'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  mentor:
    runs-on: ubuntu-latest
    if: github.actor == 'pertrai1' && contains(github.event.pull_request.labels.*.name, 'code challenge')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract Problem Info
        id: problem
        run: |
          # Get files changed in this PR
          PROBLEM_PATH=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '(leetcode|greatfrontend|[0-9]+-[a-zA-Z0-9-]+)' | head -1)

          if [ -z "$PROBLEM_PATH" ]; then
            echo "No coding challenge files found"
            echo "found=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "found=true" >> $GITHUB_OUTPUT
          echo "path=$PROBLEM_PATH" >> $GITHUB_OUTPUT

          # Determine platform
          if echo "$PROBLEM_PATH" | grep -q "^leetcode/"; then
            PLATFORM="LeetCode"
          elif echo "$PROBLEM_PATH" | grep -q "^greatfrontend/"; then
            PLATFORM="GreatFrontEnd"
          else
            PLATFORM="Unknown"
          fi
          echo "platform=$PLATFORM" >> $GITHUB_OUTPUT

          # Extract difficulty from path (leetcode/easy/, leetcode/medium/, leetcode/hard/)
          if echo "$PROBLEM_PATH" | grep -q "leetcode/easy"; then
            DIFFICULTY="Easy"
          elif echo "$PROBLEM_PATH" | grep -q "leetcode/medium"; then
            DIFFICULTY="Medium"
          elif echo "$PROBLEM_PATH" | grep -q "leetcode/hard"; then
            DIFFICULTY="Hard"
          elif echo "$PROBLEM_PATH" | grep -q "greatfrontend"; then
            DIFFICULTY="Varies"
          else
            DIFFICULTY="Unknown"
          fi
          echo "difficulty=$DIFFICULTY" >> $GITHUB_OUTPUT

          # Extract problem number and name
          # Pattern: 0001-two-sum or 1034-subarrays-with-k-different-integers
          PROBLEM_FOLDER=$(echo "$PROBLEM_PATH" | grep -oE '[0-9]+-[a-zA-Z0-9-]+' | head -1)
          if [ -n "$PROBLEM_FOLDER" ]; then
            PROBLEM_NUM=$(echo "$PROBLEM_FOLDER" | grep -oE '^[0-9]+')
            PROBLEM_NAME=$(echo "$PROBLEM_FOLDER" | sed 's/^[0-9]*-//' | tr '-' ' ' | sed 's/\b\(.\)/\u\1/g')
          else
            # For non-numbered problems (e.g., GreatFrontEnd)
            PROBLEM_NUM=""
            PROBLEM_NAME=$(basename $(dirname "$PROBLEM_PATH") | tr '-' ' ' | sed 's/\b\(.\)/\u\1/g')
          fi

          echo "problem_num=$PROBLEM_NUM" >> $GITHUB_OUTPUT
          echo "problem_name=$PROBLEM_NAME" >> $GITHUB_OUTPUT
          echo "problem_folder=$PROBLEM_FOLDER" >> $GITHUB_OUTPUT

      - name: Read Solution File
        if: steps.problem.outputs.found == 'true'
        id: solution
        run: |
          # Find the solution file
          PROBLEM_PATH="${{ steps.problem.outputs.path }}"
          SOLUTION_DIR=$(dirname "$PROBLEM_PATH")

          # Look for .js or .ts solution file
          SOLUTION_FILE=$(find "$SOLUTION_DIR" -maxdepth 1 -type f \( -name "*.js" -o -name "*.ts" \) ! -name "*.test.*" ! -name "*.spec.*" | head -1)

          if [ -n "$SOLUTION_FILE" ] && [ -f "$SOLUTION_FILE" ]; then
            echo "file=$SOLUTION_FILE" >> $GITHUB_OUTPUT
            # Extract complexity comments if present
            TIME_COMPLEXITY=$(grep -i "time.*O(" "$SOLUTION_FILE" | head -1 || echo "Not specified")
            SPACE_COMPLEXITY=$(grep -i "space.*O(" "$SOLUTION_FILE" | head -1 || echo "Not specified")
            echo "time_complexity=$TIME_COMPLEXITY" >> $GITHUB_OUTPUT
            echo "space_complexity=$SPACE_COMPLEXITY" >> $GITHUB_OUTPUT
          fi

      - name: Generate Learning Card
        if: steps.problem.outputs.found == 'true'
        id: learning_card
        run: |
          cat > learning-card.md << 'EOF'
          ## ðŸ“š Coding Challenge Learning Card

          | Property | Value |
          |----------|-------|
          | **Platform** | ${{ steps.problem.outputs.platform }} |
          | **Problem** | ${{ steps.problem.outputs.problem_num }}${{ steps.problem.outputs.problem_num && ' - ' || '' }}${{ steps.problem.outputs.problem_name }} |
          | **Difficulty** | ${{ steps.problem.outputs.difficulty }} |
          | **File** | `${{ steps.problem.outputs.path }}` |

          ---

          ### ðŸŽ¯ Learning Focus Checklist

          When reviewing this solution, identify:

          - [ ] **Primary Pattern/Concept**: What main pattern or concept is used?
            - Algorithms: Sliding Window, Two Pointers, DP, BFS/DFS, etc.
            - Frontend: Closures, Event Delegation, Async Patterns, etc.
          - [ ] **Secondary Techniques**: Are there supporting techniques?
          - [ ] **Data Structures/APIs**: What enables this solution?

          ---

          ### ðŸ§  Key Insight Question

          > *What is the "aha!" moment that makes this solution work?*
          >
          > Every problem has a non-obvious insight. For example:
          > - "Subarrays with K Distinct": `exactlyK = atMostK(k) - atMostK(k-1)`
          > - "Two Sum": Use hash map for O(1) complement lookup
          > - "Debounce": Closures capture timer ID for cancellation

          ---

          ### ðŸ“– Related Problems to Practice

          After solving this problem, try these related problems that use similar patterns:

          | Platform | Problem | Pattern |
          |----------|---------|---------|
          | TBD | *Easier prerequisite* | Same core concept |
          | TBD | *Similar problem* | Same pattern, different constraints |
          | TBD | *Harder variation* | Extended or combined pattern |

          ---

          ### ðŸ’¡ Interview Tips

          - **Opening**: Start by clarifying the problem and identifying edge cases
          - **Approach**: Explain the brute force first, then optimize
          - **Complexity**: Always state and explain time/space complexity (for algorithmic problems)
          - **Trade-offs**: Discuss alternative approaches and their trade-offs

          ---

          ### âš ï¸ Common Mistakes

          Watch out for these typical mistakes:

          1. **Off-by-one errors**: Check loop boundaries carefully
          2. **Edge cases**: Empty input, single element, null/undefined values
          3. **Memory leaks**: Clean up event listeners, timers, references
          4. **Async issues**: Handle promises properly, avoid race conditions

          ---

          *ðŸ’¬ AI reviewers will fill in the specific details for this problem based on the solution code.*
          EOF

      - name: Post Learning Card Comment
        if: steps.problem.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let learningCard = '## ðŸ“š Coding Challenge Learning Card\n\n';
            learningCard += '**Problem analysis pending...**\n\n';

            try {
              learningCard = fs.readFileSync('learning-card.md', 'utf8');
            } catch (e) {
              console.log('Could not read learning card:', e.message);
            }

            // Check if we already commented on this PR
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.login === 'github-actions[bot]' &&
              comment.body.includes('ðŸ“š Coding Challenge Learning Card')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: learningCard
              });
              console.log('Updated existing Coding Challenge Learning Card comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: learningCard
              });
              console.log('Created new Coding Challenge Learning Card comment');
            }
