name: Daily Learning Issue

on:
  schedule:
    - cron: '0 12 * * *' # 7am ET
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  create_learning_issue:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Define learning buckets
        id: buckets
        run: |
          cat << 'EOF' > buckets.json
          {
            "Prompt Engineering": [
              "Instruction-following vs completion behavior",
              "Prompt brittleness under schema changes",
              "Over-specification vs under-specification",
              "Prompt leakage failure modes",
              "Multi-step prompt degradation"
            ],
            "Agents": [
              "Tool selection failure modes",
              "Planning vs execution separation",
              "Agent loop termination conditions",
              "State drift over long horizons",
              "Error compounding across tool calls"
            ],
            "Evaluation": [
              "Offline vs online evaluation mismatch",
              "LLM-as-judge failure modes",
              "Metric gaming risks",
              "Ground truth ambiguity",
              "Confidence calibration errors"
            ]
          }
          EOF

      - name: Fetch recent focuses
        id: recent
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue list \
            --limit 5 \
            --label daily-learning \
            --json body \
            --jq '[.[] | capture("Focus:\\s*(?<f>.*)")?.f] | map(select(. != null))' \
            > recent.json

      - name: Select bucket and focus
        id: select
        run: |
          BUCKET=$(jq -r 'keys[]' buckets.json | shuf -n 1)

          RECENT=$(jq -r '.[]' recent.json || true)

          jq -r --arg bucket "$BUCKET" '
            .[$bucket][]' buckets.json \
          | grep -vxF "$RECENT" \
          | shuf -n 1 \
          > focus.txt

          # Fallback if all were recently used
          if [ ! -s focus.txt ]; then
            jq -r --arg bucket "$BUCKET" '.[$bucket][]' buckets.json | shuf -n 1 > focus.txt
          fi

          echo "BUCKET=$BUCKET" >> $GITHUB_ENV
          echo "FOCUS=$(cat focus.txt)" >> $GITHUB_ENV

      - name: Set date
        run: |
          echo "DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

      - name: Create daily learning issue
        uses: JasonEtco/create-an-issue@v2.9.1
        with:
          filename: .github/ISSUE_TEMPLATES/daily-learning.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CONFIDENCE: '__'
          SYSTEM_TYPE: '__'
