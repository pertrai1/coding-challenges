name: Quiz Answer Command

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write
  actions: read

jobs:
  provide-answers:
    runs-on: ubuntu-latest
    name: Provide Quiz Answers
    if: |
      !github.event.issue.pull_request &&
      contains(github.event.comment.body, '/answers') &&
      (github.event.issue.user.login == 'pertrai1' || github.actor == 'pertrai1') &&
      contains(join(github.event.issue.labels.*.name, ','), 'quiz')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Extract quiz metadata
        id: quiz-meta
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.issue.labels.map(label => label.name);
            const quizAnswersLabel = labels.find(label => label.startsWith('quiz-answers-'));

            if (!quizAnswersLabel) {
              console.log('No quiz-answers label found');
              return { found: false };
            }

            const timestamp = quizAnswersLabel.replace('quiz-answers-', '');
            const techniqueName = labels.find(label =>
              label !== 'quiz' &&
              label !== 'algorithm' &&
              label !== 'auto-generated' &&
              !label.startsWith('quiz-answers-')
            );

            console.log(`Found quiz metadata: technique=${techniqueName}, timestamp=${timestamp}`);

            return {
              found: true,
              timestamp: timestamp,
              techniqueName: techniqueName || 'unknown',
              issueNumber: context.issue.number
            };

      - name: Check for existing answer comment
        id: existing-comment
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingAnswer = comments.find(comment =>
              comment.user.login === 'github-actions[bot]' &&
              comment.body.includes('ðŸ”‘ Quiz Answer Key')
            );

            return {
              exists: !!existingAnswer,
              commentId: existingAnswer?.id
            };

      - name: Download answer artifacts
        if: fromJSON(steps.quiz-meta.outputs.result).found && !fromJSON(steps.existing-comment.outputs.result).exists
        id: download-answers
        run: |
          TIMESTAMP="${{ fromJSON(steps.quiz-meta.outputs.result).timestamp }}"
          TECHNIQUE="${{ fromJSON(steps.quiz-meta.outputs.result).techniqueName }}"

          echo "Looking for answers file: answers-${TECHNIQUE}-${TIMESTAMP}.md"

          # Try to download recent workflow artifacts
          # Note: This uses GitHub CLI to search for artifacts
          gh run list --limit 50 --json workflowName,conclusion,createdAt,databaseId \
            --jq '.[] | select(.workflowName == "Algorithm Quiz Generator" and .conclusion == "success")' > recent_runs.json

          FOUND_ANSWERS=false

          # Check each recent successful run for our artifact
          while IFS= read -r run; do
            if [ -z "$run" ]; then continue; fi

            RUN_ID=$(echo "$run" | jq -r '.databaseId')
            echo "Checking run $RUN_ID for artifacts..."

            # Download artifact if it exists and contains our answers
            if gh run download $RUN_ID --name algorithm-quiz-answers 2>/dev/null; then
              if [ -f "answers-${TECHNIQUE}-${TIMESTAMP}.md" ]; then
                echo "Found answers file!"
                FOUND_ANSWERS=true
                break
              else
                echo "Artifact downloaded but answers file not found"
                rm -rf answers-*.md quiz-results.json 2>/dev/null || true
              fi
            fi
          done < <(cat recent_runs.json)

          if [ "$FOUND_ANSWERS" = "true" ]; then
            echo "answers_found=true" >> $GITHUB_OUTPUT
            echo "answers_file=answers-${TECHNIQUE}-${TIMESTAMP}.md" >> $GITHUB_OUTPUT
          else
            echo "answers_found=false" >> $GITHUB_OUTPUT
            echo "Could not locate answers file for this quiz"
          fi

          rm -f recent_runs.json
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Post answers comment
        if: fromJSON(steps.quiz-meta.outputs.result).found && !fromJSON(steps.existing-comment.outputs.result).exists
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const quizMeta = ${{ steps.quiz-meta.outputs.result }};

            let answerContent = '';
            let answersFound = '${{ steps.download-answers.outputs.answers_found }}' === 'true';

            if (answersFound) {
              try {
                const answersFile = '${{ steps.download-answers.outputs.answers_file }}';
                answerContent = fs.readFileSync(answersFile, 'utf8');
              } catch (e) {
                console.log('Error reading answers file:', e.message);
                answersFound = false;
              }
            }

            let commentBody;

            if (answersFound) {
              commentBody = `# ðŸ”‘ Quiz Answer Key

            **Technique:** ${quizMeta.techniqueName.replace(/_/g, ' ')}
            **Requested by:** @${context.actor}

            ---

            ${answerContent}

            ---

            ## ðŸ“š Additional Resources

            - **Technique Documentation:** [\`docs/techniques/${quizMeta.techniqueName}.md\`](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/docs/techniques/${quizMeta.techniqueName}.md)
            - **Practice Problems:** Check the technique documentation for LeetCode problem recommendations
            - **Implementation Examples:** Review the code examples in the technique guide

            ## ðŸ’¡ Study Tips

            1. **Understand the Why:** Focus on understanding when and why to use this technique
            2. **Practice Pattern Recognition:** Try to identify this pattern in new problems
            3. **Analyze Complexity:** Always consider time and space trade-offs
            4. **Code Implementation:** Practice writing clean, bug-free implementations

            *Keep practicing! The more you work with these patterns, the more intuitive they become. ðŸš€*`;
            } else {
              commentBody = `# âš ï¸ Answers Temporarily Unavailable

            **Technique:** ${quizMeta.techniqueName.replace(/_/g, ' ')}
            **Requested by:** @${context.actor}

            The answer key for this quiz could not be retrieved at this time. This may be because:

            - The quiz was generated recently and artifacts are still being processed
            - The answer artifacts have expired (90-day retention)
            - There was an issue during quiz generation

            ## ðŸ“š Alternative Resources

            While we work to restore the answers, you can find detailed explanations in:
            - **Technique Documentation:** [\`docs/techniques/${quizMeta.techniqueName}.md\`](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/docs/techniques/${quizMeta.techniqueName}.md)
            - **Analysis Files:** Check \`docs/analysis/\` for related complexity analyses
            - **Code Examples:** Review existing implementations in the LeetCode directories

            Try again later, or feel free to discuss specific questions in the comments!`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });

            console.log('Posted answer comment successfully');

      - name: Handle existing answer comment
        if: fromJSON(steps.quiz-meta.outputs.result).found && fromJSON(steps.existing-comment.outputs.result).exists
        uses: actions/github-script@v7
        with:
          script: |
            const quizMeta = ${{ steps.quiz-meta.outputs.result }};

            const responseBody = `@${context.actor} The answer key has already been provided above! ðŸ‘†

            If you're looking for additional help with specific questions, feel free to ask in the comments and I'll try to provide more detailed explanations.

            **Quick Links:**
            - **Technique Guide:** [\`docs/techniques/${quizMeta.techniqueName}.md\`](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/docs/techniques/${quizMeta.techniqueName}.md)`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: responseBody
            });

      - name: Handle unauthorized access
        if: |
          contains(github.event.comment.body, '/answers') &&
          !(github.event.issue.user.login == 'pertrai1' || github.actor == 'pertrai1') &&
          contains(join(github.event.issue.labels.*.name, ','), 'quiz')
        uses: actions/github-script@v7
        with:
          script: |
            const responseBody = `@${context.actor} Thanks for your interest! ðŸŽ“

            The \`/answers\` command is currently restricted to repository maintainers to encourage learning through problem-solving first.

            **Here's how you can approach the quiz:**
            1. **Work through the questions** using the technique documentation
            2. **Research and experiment** with the concepts
            3. **Discuss your thoughts** in the comments - I'm happy to provide hints!
            4. **Check the technique guide** for detailed explanations and examples

            **Resources to help you:**
            - **Technique Documentation:** Check the linked documentation in the issue description
            - **Code Examples:** Look for related problems in the \`leetcode/\` directories
            - **Analysis Files:** Review \`docs/analysis/\` for complexity breakdowns

            Learning by working through problems yourself is much more valuable than just seeing the answers! ðŸ’ª`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: responseBody
            });

      - name: Cleanup downloaded files
        if: always()
        run: |
          rm -rf answers-*.md quiz-results.json recent_runs.json 2>/dev/null || true
