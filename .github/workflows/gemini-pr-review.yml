name: Gemini Code Review
on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    # Remove the line below if you want this to run for all contributors
    if: github.actor == 'pertrai1'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare Pull Request Diff
        run: |
          git diff origin/${{ github.base_ref }}...HEAD > pr_diff.txt

          # Increased limit to 300KB (Flash handles large context easily)
          DIFF_SIZE=$(wc -c < pr_diff.txt)
          if [ $DIFF_SIZE -gt 300000 ]; then
            echo "Diff is extremely large. Truncating to 300KB..."
            head -c 300000 pr_diff.txt > pr_diff_truncated.txt
            mv pr_diff_truncated.txt pr_diff.txt
          fi
          echo "Diff size: $(wc -c < pr_diff.txt) bytes"

      - name: Read Guidelines
        run: |
          # Look for a custom guidelines file (e.g., CLAUDE.md or CONTRIBUTING.md)
          if [ -f "CLAUDE.md" ]; then
            cat CLAUDE.md | head -c 5000 > guidelines.txt
            echo "Found CLAUDE.md guidelines"
          else
            # Default guidelines if no file exists
            echo "Focus on: Algorithm correctness, efficiency, time/space complexity, code quality, TypeScript typing strictness, and edge cases." > guidelines.txt
          fi

      - name: Generate Review with Gemini
        id: gemini
        env:
          API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # 1. Construct the JSON payload safely using jq
          # This prevents shell injection errors and handles newlines correctly
          jq -n \
            --arg prompt "You are a DSA mentor reviewing code for learning purposes. This repository contains LeetCode solutions for practicing algorithmic problem-solving.

          REVIEW STRUCTURE:
          1. **Pattern Identification**: What algorithmic pattern does this solution use? (e.g., Sliding Window, Two Pointers, Dynamic Programming, BFS/DFS, Binary Search, etc.)

          2. **Complexity Verification**: 
             - Is the stated time complexity accurate? If not, what is the correct complexity and why?
             - Is the stated space complexity accurate? If not, what is the correct complexity and why?

          3. **Key Insight**: What is the key insight or 'aha!' moment that makes this solution work? Every problem has a non-obvious trick - explain it clearly.

          4. **Edge Case Analysis**: What edge cases should be tested? Are there any edge cases the current solution might not handle correctly?

          5. **Learning Points**:
             - What similar problems use this same pattern?
             - What are common mistakes people make with this pattern?
             - What variations of this problem exist?

          6. **Code Quality**: Suggest improvements for variable naming, code structure, or readability.

          7. **Alternative Approaches**: Briefly mention 1-2 other ways to solve this problem with their trade-offs.

          Be educational - explain the 'why' behind your feedback to help the developer learn and recognize patterns in future problems." \
            --rawfile guidelines guidelines.txt \
            --rawfile diff pr_diff.txt \
            '{
              contents: [{
                parts: [
                  {text: $prompt},
                  {text: ("\n\nGUIDELINES:\n" + $guidelines)},
                  {text: "\n\nProvide your review in Markdown format with the sections outlined above.\n\nCODE DIFF:\n"},
                  {text: $diff}
                ]
              }],
              generationConfig: {
                temperature: 0.7,
                maxOutputTokens: 8192
              }
            }' > payload.json

          # 2. Call Gemini API (v1beta endpoint for latest models)
          # Using gemini-2.5-flash as requested. If not available, fallback to gemini-1.5-flash
          curl -s \
            -H "Content-Type: application/json" \
            -d @payload.json \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=$API_KEY" > response.json

          # 3. Extract Review Text
          REVIEW_TEXT=$(cat response.json | jq -r '.candidates[0].content.parts[0].text // empty')

          if [ -z "$REVIEW_TEXT" ]; then
            echo "⚠️ Failed to extract review from Gemini API." > review_comment.md
            echo "<details><summary>Debug Response</summary><pre>" >> review_comment.md
            cat response.json >> review_comment.md
            echo "</pre></details>" >> review_comment.md
          else
            echo "$REVIEW_TEXT" > review_comment.md
          fi

      - name: Post Comment to PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          gh pr comment "$PR_NUMBER" --body-file review_comment.md
